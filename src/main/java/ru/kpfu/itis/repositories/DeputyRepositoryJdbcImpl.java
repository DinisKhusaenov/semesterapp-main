package ru.kpfu.itis.repositories;


import ru.kpfu.itis.form.VoteForm;
import ru.kpfu.itis.models.Deputy;

import javax.sql.DataSource;
import java.sql.*;
import java.util.List;
import java.util.Optional;

import static ru.kpfu.itis.queries.DeputyQueries.*;
import static ru.kpfu.itis.queries.UserQueries.SQL_INSERT;

public class DeputyRepositoryJdbcImpl implements DeputyRepository {

    private final DataSource dataSource;
    private final SimpleJdbcTemplate template;

    private final RowMapper<Deputy> deputyRowMapper = row -> Deputy.builder()
            .id(row.getLong("id"))
            .first_name(row.getString("first_name"))
            .last_name(row.getString("last_name"))
            .age(row.getInt("age"))
            .vote(row.getDouble("vote"))
            .photo(row.getString("photo"))
            .title(row.getString("title"))
            .fraction(row.getString("fraction"))
            .build();

    public DeputyRepositoryJdbcImpl(DataSource dataSource) {
        this.dataSource = dataSource;
        this.template = new SimpleJdbcTemplate(dataSource);
    }

    @Override
    public void save(Deputy entity) {
        try (Connection connection = dataSource.getConnection();
             PreparedStatement preparedStatement = connection.prepareStatement(SQL_INSERT, Statement.RETURN_GENERATED_KEYS)) {

            int i = 1;
            preparedStatement.setString(i++, entity.getFirst_name());
            preparedStatement.setString(i++, entity.getLast_name());
            preparedStatement.setInt(i++, entity.getAge());
            preparedStatement.setDouble(i++, entity.getVote());
            preparedStatement.setString(i++, entity.getPhoto());
            preparedStatement.setString(i++, entity.getTitle());

            preparedStatement.executeUpdate();

            // setting the ID value generated by the database
            try (ResultSet resultSet = preparedStatement.getGeneratedKeys()) {
                resultSet.next();
                Long id = resultSet.getLong(1);
                entity.setId(id);
            }
        } catch (SQLException e) {
            throw new IllegalStateException(e);
        }
    }

    @Override
    public void update(Deputy entity) {
        template.query(SQL_UPDATE_BY_ID, deputyRowMapper, entity.getFirst_name(), entity.getLast_name(),
                entity.getAge(), entity.getVote(), entity.getPhoto(), entity.getTitle());
    }

    @Override
    public void delete(Deputy entity) {
        template.query(SQL_DELETE_BY_ID, deputyRowMapper, entity.getId());
    }

    @Override
    public Optional<Deputy> findById(Long id) {
        // this query will return list with only one user.
        // findAny returns this user.
        return template.queryForList(SQL_SELECT_BY_ID, deputyRowMapper, id).stream().findAny();
    }

    @Override
    public List<Deputy> findAll() {
        return template.queryForList(SQL_SELECT, deputyRowMapper);
    }

    @Override
    public Optional<Deputy> findByName(String first_name) {
        // this query will return list with only one user.
        // findAny returns this user.
        return template.queryForList(SQL_SELECT_BY_FIRST_NAME, deputyRowMapper, first_name).stream().findAny();
    }

    @Override
    public List<Deputy> getVoteDeputy(VoteForm voteForm) {
        List<Deputy> deputies = template.queryForList(SQL_SELECT_BY_ID, deputyRowMapper, voteForm.getFirst_name());
        return deputies;
    }
}
